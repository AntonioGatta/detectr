flour = require 'flour'
path = require 'path'
fs = require 'fs'
{exec} = require 'child_process'

# Constants
COFFEE = 'coffee'
DOCGEN = './node_modules/codo/bin/codo'
MINIFIER = 'uglifyjs'

SOURCE = 'src'
OUTPUT = 'js'
DOCOUTPUT = './doc'

SRC_FILE = 'detectr.coffee'
TARGET = 'detectr.js'
TARGET_MIN = 'detectr.min.js'

task 'build', ->
  invoke 'doc'
  
  compile path.join(SOURCE, SRC_FILE), path.join(OUTPUT, TARGET), ->
    minify path.join(OUTPUT, TARGET), path.join(OUTPUT, TARGET_MIN)  
  

task 'doc', ->
  exec "#{DOCGEN} -o #{DOCOUTPUT}"

deleteFile = (filename) ->
  return unless fs.existsSync filename
  
  fs.unlink filename, (err) ->
    if err
      console.log "Error while deleting #{filename}: #{err}"
      return
    
    console.log "Sucessfully deleted #{filename}"

deleteFiles = (files) ->
  deleteFile file for file in files

task 'clean', -> deleteFiles [path.join(OUTPUT, TARGET), path.join(OUTPUT, TARGET_MIN)]
